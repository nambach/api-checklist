
# API & Service Build **Notebook** (Beginner‑Friendly Markdown)

> A practical, self‑contained guide you can **check off** as you design an API and build the service behind it.  
> **Goal:** make every term understandable, with plain‑English explanations, copy‑paste examples, and mini checklists.

Generated by ChatGPT 5.0 with ❤️

---

## How to use this notebook

- Skim the **Table of Contents** and jump to what you need.
- Each item includes: **What it is → Why it matters → How to do it → Example → Checklist**.
- Tick the `- [ ]` boxes as you complete work. (In many markdown tools, you can turn them into `- [x]` as you go.)
- Use the **Glossary** for any unfamiliar word.
- This file is yours — adapt it to your stack and policies.

---

## Table of Contents

1. [API Definition (interface & behavior)](#api-definition-interface--behavior)  
   1. [Scope & Semantics](#scope--semantics)  
   2. [Protocol & Shape](#protocol--shape)  
   3. [AuthN/AuthZ](#authnauthz)  
   4. [Documentation & DX](#documentation--dx)  
2. [Service Build (internals & ops)](#service-build-internals--ops)  
   1. [Architecture & Data](#architecture--data)  
   2. [Reliability & Resilience](#reliability--resilience)  
   3. [Performance & Scalability](#performance--scalability)  
   4. [Security & Privacy](#security--privacy)  
   5. [Observability](#observability)  
   6. [Testing Strategy](#testing-strategy)  
   7. [Delivery & Change Management](#delivery--change-management)  
   8. [Cost & Capacity](#cost--capacity)  
   9. [Compliance & Governance](#compliance--governance)  
3. [Go‑Live Readiness](#go-live-readiness)  
4. [Protocol Quick Guides](#protocol-quick-guides)  
   - [REST](#rest-quick-guide) | [gRPC](#grpc-quick-guide) | [Eventing/Async](#eventingasync-quick-guide)  
5. [Templates & Snippets](#templates--snippets)  
6. [Glossary (simple definitions)](#glossary-simple-definitions)  
7. [Scorecard (one‑page checklist)](#scorecard-one-page-checklist)

---

## API Definition (interface & behavior)

### Scope & Semantics

#### 1) Problem statement, success metrics, out‑of‑scope
- **What:** Write one paragraph that says *who needs what and why*, plus 3 success metrics (e.g., adoption, latency). Also write what **won't** be done now.
- **Why:** Prevent scope creep, set expectations, guide trade‑offs.
- **How:** Fill the template below.
- **Template:**  
  ```md
  **Problem:** Merchants need to issue refunds via API so support can automate workflows.  
  **Users:** Internal support bot, partner apps.  
  **Success by 60 days:** 200 DAU, P95 < 400 ms, refund error rate < 0.5%.
  **Out of scope:** Cross‑currency refunds, partial capture reversal.
  ```
- **Checklist**
  - [ ] One‑paragraph problem
  - [ ] Three measurable success metrics
  - [ ] Clear out‑of‑scope list
- **Deep dive:** [Problem Statement, Users, Success Metrics, Out‑of‑Scope](details/api_service_teaching_deep_part1.md#1-problem-statement-users-success-metrics-outofscope)

#### 2) Resource model (nouns) & operations (verbs)
- **What:** List your main **things** (e.g., `orders`, `refunds`) and allowed **actions** (`create`, `list`, `get`, `update`, `cancel`).
- **Why:** Keeps API consistent and predictable.
- **How:** Write a table of resources and operations.
- **Example:**  
  | Resource | Key fields | Operations |
  |---|---|---|
  | `refund` | `id`, `order_id`, `amount`, `status` | `POST /refunds`, `GET /refunds/{id}`, `GET /refunds?order_id=...`, `POST /refunds/{id}:cancel` |
- **Checklist**
  - [ ] Resource list with key fields
  - [ ] Explicit allowed operations per resource
- **Deep dive:** [Resource Model (nouns) & Operations (verbs)](details/api_service_teaching_deep_part1.md#2-resource-model-nouns--operations-verbs)

#### 3) Consistency model
- **What:** How quickly reads reflect writes. Common choices: **strong** (immediate), **read‑your‑writes** (caller sees own recent writes), **eventual** (may lag).
- **Why:** Sets expectations for UX and caches; avoids "why didn't I see my update?" confusion.
- **How:** Decide per endpoint and state it in docs.
- **Example:** "`GET /refunds/{id}` is **strongly consistent**. `GET /orders/{id}/refunds` may be **eventually consistent** up to 2 seconds."
- **Checklist**
  - [ ] Each read endpoint states its consistency
  - [ ] Clients told how to detect freshness (e.g., ETag/version)
- **Deep dive:** [Consistency Model (strong, read‑your‑writes, eventual)](details/api_service_teaching_deep_part1.md#3-consistency-model-strong-readyourwrites-eventual)

#### 4) Idempotency (safe retries)
- **What:** The same request sent again has the **same effect** as the first time.
- **Why:** Network hiccups cause retries; idempotency prevents double‑charges/duplicates.
- **How:** Require an **Idempotency‑Key** header for non‑GET writes; store request hash + result for a window (e.g., 24h).
- **Example:**  
  ```http
  POST /refunds
  Idempotency-Key: 3bbf9b0c-...

  { "order_id": "o_123", "amount": 1000 }
  ```
- **Checklist**
  - [ ] Non‑GET endpoints accept `Idempotency-Key`
  - [ ] Server dedupes and returns the first result
- **Deep dive:** [Idempotency (safe retries for non‑GET writes)](details/api_service_teaching_deep_part1.md#4-idempotency-safe-retries-for-nonget-writes)

#### 5) Concurrency control
- **What:** Protect against **lost updates** when two writers edit the same thing.
- **Why:** Prevent one client from silently overwriting another's changes.
- **How:** Use **optimistic concurrency** with version/`ETag` and `If‑Match`.
- **Example:**  
  ```http
  GET /orders/123
  ETag: "v7"

  PATCH /orders/123
  If-Match: "v7"
  { "note": "Ship ASAP" }
  ```
- **Checklist**
  - [ ] Resources have version/ETag
  - [ ] Update endpoints honor `If‑Match`
- **Deep dive:** [Concurrency Control (optimistic via ETag/If‑Match)](details/api_service_teaching_deep_part1.md#5-concurrency-control-optimistic-via-etagifmatch)

#### 6) Time semantics
- **What:** Use standard time formats and rules.
- **Why:** Time bugs are sneaky (zones, DST). Consistency avoids them.
- **How:** Timestamps in **RFC 3339 UTC** (`2025-01-30T14:57:00Z`). Durations/intervals in **ISO‑8601**. Allow small **clock skew** (e.g., ±5m).
- **Checklist**
  - [ ] All timestamps UTC RFC 3339
  - [ ] Durations ISO‑8601 (`PT30S`, `P1D`)
  - [ ] Server tolerates client clock skew
- **Deep dive:** [Time Semantics (UTC, RFC3339, ISO‑8601, skew)](details/api_service_teaching_deep_part1.md#6-time-semantics-utc-rfc3339-iso8601-skew)

---

### Protocol & Shape

#### 7) Transport choice (REST/JSON, gRPC/Protobuf, GraphQL, events)
- **What:** The "wire" your API uses.
- **Why:** Impacts performance, tooling, and developer experience.
- **How:** Pick based on needs:
  - **REST/JSON:** human‑readable, caching, broad tooling.
  - **gRPC/Protobuf:** binary, fast, great for internal service‑to‑service.
  - **GraphQL:** flexible querying from browsers/mobile; server must protect against heavy queries.
  - **Events:** async messaging for notifications/streams.
- **Checklist**
  - [ ] Transport chosen and justified
  - [ ] Security & limits suited to transport
- **Deep dive:** [Transport Choice (REST/JSON, gRPC/Protobuf, GraphQL, Events)](details/api_service_teaching_deep_part1.md#7-transport-choice-restjson-grpcprotobuf-graphql-events)

#### 8) Versioning policy
- **What:** Rules for changes over time.
- **Why:** Avoid breaking existing clients.
- **How:** Make **additive** changes in the same major version; use a new **major** for breaking changes; publish a **deprecation window**.
- **Example:** "v1 guarantees no breaking changes; v2 will be announced 180 days before retirement of v1."
- **Checklist**
  - [ ] Major/minor policy written
  - [ ] Deprecation timeline/process in docs
- **Deep dive:** [Versioning Policy (additive changes, deprecations, majors)](details/api_service_teaching_deep_part1.md#8-versioning-policy-additive-changes-deprecations-majors)

#### 9) Pagination
- **What:** Return large lists in pages using a **cursor** (opaque token) and `limit`.
- **Why:** Protects servers and clients; stable paging.
- **How:** Include `next_page_token` in responses; sort by a stable key (e.g., `created_at,id`).
- **Example:**  
  ```http
  GET /refunds?limit=50&page_token=eyJvZmZzZXQiOiIxNzAw...

  200 OK
  { "items": [...], "next_page_token": "..." }
  ```
- **Checklist**
  - [ ] Cursor‑based paging
  - [ ] Stable sort and `limit` caps
- **Deep dive:** [Pagination with Cursor & Limit Caps](details/api_service_teaching_deep_part1.md#9-pagination-with-cursor--limit-caps)

#### 10) Filtering & sorting
- **What:** Parameters to narrow and order results safely.
- **Why:** Avoids unbounded scans that hurt performance.
- **How:** Whitelist fields and operators; combine with `limit`.
- **Example:** `GET /orders?status=paid&created_after=2025-01-01&sort=-created_at`
- **Checklist**
  - [ ] Documented filters and sorts
  - [ ] Guardrails to prevent full‑table scans
- **Deep dive:** [Filtering & Sorting (bounded and index‑backed)](details/api_service_teaching_deep_part1.md#10-filtering--sorting-bounded-and-indexbacked)

#### 11) Error model
- **What:** A **single, typed** error shape so clients handle problems consistently.
- **Why:** Clear debugging; better UX.
- **How:** Return HTTP code + JSON body with fields like `type`, `code`, `message`, `details`, `request_id`.
- **Example:**  
  ```json
  {
    "type": "validation_error",
    "code": "amount_too_small",
    "message": "Minimum is 1.00",
    "details": { "field": "amount", "min": 100 },
    "request_id": "req_abc123"
  }
  ```
- **Checklist**
  - [ ] One error schema used everywhere
  - [ ] Error catalog documented
- **Deep dive:** [Error Model (one typed schema)](details/api_service_teaching_deep_part1.md#11-error-model-one-typed-schema)

#### 12) Partial success for batch ops
- **What:** Some items succeed, some fail.
- **Why:** Clients can retry only failures.
- **How:** Include `successes` and `errors` arrays.
- **Example:**  
  ```json
  { "successes": [{"id":"r_1"}], "errors": [{"index":1,"code":"invalid"}] }
  ```
- **Checklist**
  - [ ] Batch endpoints specify partial‑success format
- **Deep dive:** [Partial Success for Batch Operations](details/api_service_teaching_deep_part1.md#12-partial-success-for-batch-operations)

#### 13) Rate limiting & quotas
- **What:** Control request **rate** per client/user to keep the system healthy.
- **Why:** Prevent overload and fair use.
- **How:** Token bucket or leaky bucket; return 429 with `Retry‑After` and limit headers.
- **Example headers:**  
  ```http
  X-RateLimit-Limit: 100
  X-RateLimit-Remaining: 72
  X-RateLimit-Reset: 1735689600
  Retry-After: 12
  ```
- **Checklist**
  - [ ] Limits defined per principal (user/app/tenant)
  - [ ] 429 behavior and headers documented
- **Deep dive:** [Rate Limiting & Quotas (fairness and protection)](details/api_service_teaching_deep_part1.md#13-rate-limiting--quotas-fairness-and-protection)

#### 14) Headers: tracing, idempotency, caching, content type
- **What:** Standard headers to correlate and cache.
- **Why:** Speeds debugging and performance.
- **How:** Accept/emit: `traceparent`, `Idempotency-Key`, `ETag`, `Cache-Control`, `Content-Type: application/json`.
- **Checklist**
  - [ ] Trace/correlation ID flows end‑to‑end
  - [ ] Caching headers used where safe
- **Deep dive:** [Standard Headers (tracing, idempotency, caching, content type)](details/api_service_teaching_deep_part1.md#14-standard-headers-tracing-idempotency-caching-content-type)

#### 15) Localization
- **What:** User‑visible text vs. machine‑readable codes.
- **Why:** Avoid parsing human text; keep errors stable.
- **How:** Put **stable codes** in APIs; translate only in UI.
- **Checklist**
  - [ ] APIs return codes/enums, not prose meant for UI
- **Deep dive:** [Localization (codes over prose)](details/api_service_teaching_deep_part1.md#15-localization-codes-over-prose)

---

### AuthN/AuthZ

#### 16) Authentication (AuthN)
- **What:** Verifying **who** is calling. Use OAuth2/OIDC for users; mTLS or signed JWTs for service‑to‑service.
- **Why:** Only legit callers get in.
- **How:** Pick grant types (client creds, auth code), rotate keys, support token introspection.
- **Checklist**
  - [ ] Auth method(s) chosen and documented
  - [ ] Key/secret rotation policy
- **Deep dive:** [Authentication (AuthN)](details/api_service_teaching_deep_part2.md#16-authentication-authn)

#### 17) Authorization (AuthZ)
- **What:** What a caller is **allowed** to do (RBAC = roles; ABAC = attributes/conditions).
- **Why:** Least privilege and tenant isolation.
- **How:** Define resources, actions, and policy checks; default to "read your own."
- **Checklist**
  - [ ] Policy model defined (RBAC/ABAC)
  - [ ] Tenancy boundaries enforced in queries
- **Deep dive:** [Authorization (AuthZ)](details/api_service_teaching_deep_part2.md#17-authorization-authz)

#### 18) Secret handling & logging
- **What:** Keep secrets out of URLs and logs; mask PII in logs.
- **Why:** URLs leak; logs are long‑lived.
- **How:** Pass secrets in headers/bodies; log with structured fields and masking.
- **Checklist**
  - [ ] No secrets in URLs
  - [ ] PII/log masking rules in place
- **Deep dive:** [Secret Handling & Logging](details/api_service_teaching_deep_part2.md#18-secret-handling--logging)

---

### Documentation & DX (Developer Experience)

#### 19) Executable spec
- **What:** OpenAPI (for REST) or Protobuf (for gRPC) with comments, examples, and error catalog.
- **Why:** Single source of truth; auto‑gen SDKs and mocks.
- **How:** Keep spec in repo; validate in CI.
- **Checklist**
  - [ ] Spec complete and versioned
  - [ ] Examples and error catalog embedded
- **Deep dive:** [Executable Spec (OpenAPI/Proto)](details/api_service_teaching_deep_part2.md#19-executable-spec-openapiproto)

#### 20) Quickstart
- **What:** A 5‑minute path to "Hello World" (auth + one call).
- **Why:** Reduces friction and support tickets.
- **How:** Provide `curl` and one SDK snippet.
- **Checklist**
  - [ ] Minimal auth flow shown
  - [ ] Sample request/response
- **Deep dive:** [Quickstart (developer path to first success)](details/api_service_teaching_deep_part2.md#20-quickstart-developer-path-to-first-success)

#### 21) Change log & deprecations
- **What:** One page tracking changes and timelines.
- **Why:** Consumers plan upgrades.
- **How:** Keep dated entries; email/webhooks for breaking changes.
- **Checklist**
  - [ ] Changelog page exists
  - [ ] Deprecation notifications defined
- **Deep dive:** [Changelog & Deprecations](details/api_service_teaching_deep_part2.md#21-changelog--deprecations)

#### 22) Mocks & SDKs
- **What:** Mock server/Postman collection and generated clients.
- **Why:** Faster onboarding and testing.
- **How:** Publish artifacts beside docs.
- **Checklist**
  - [ ] Mock/collection available
  - [ ] SDKs for top languages
- **Deep dive:** [Mocks & SDKs](details/api_service_teaching_deep_part2.md#22-mocks--sdks)

---

## Service Build (internals & ops)

### Architecture & Data

#### 23) Data model review
- **What:** Keys, indexes, and how data will be queried.
- **Why:** Prevents slow queries and data anomalies.
- **How:** Map **access patterns** → indexes; write sample queries.
- **Checklist**
  - [ ] Primary keys & secondary indexes defined
  - [ ] Access patterns validated
- **Deep dive:** [Data Model Review (keys, indexes, access patterns)](details/api_service_teaching_deep_part2.md#23-data-model-review-keys-indexes-access-patterns)

#### 24) Migrations (expand → migrate → contract)
- **What:** A safe 3‑step rollout: **add** new columns, **backfill**, then **remove** old ones.
- **Why:** Zero‑downtime schema changes.
- **How:** Gate code by feature flags; backfill safely.
- **Checklist**
  - [ ] Plan for expand/migrate/contract
  - [ ] Backfill and rollback steps written
- **Deep dive:** [Migrations (expand → migrate → contract)](details/api_service_teaching_deep_part2.md#24-migrations-expand--migrate--contract)

#### 25) Identifiers
- **What:** Unique IDs; sometimes sortable (by time).
- **Why:** Avoid collisions; enable time‑ordered queries.
- **How:** Use UUIDv7/ULID for sortable IDs where helpful.
- **Checklist**
  - [ ] ID format chosen (UUIDv7/ULID/DB seq)
  - [ ] No guessable identifiers for sensitive data
- **Deep dive:** [Identifiers (UUIDv7/ULID, non‑guessable)](details/api_service_teaching_deep_part2.md#25-identifiers-uuidv7ulid-nonguessable)

#### 26) Caching
- **What:** Store copies (CDN, edge, service memory, DB cache) to speed reads.
- **Why:** Lower latency and cost.
- **How:** Define what to cache, TTLs, and invalidation/signals.
- **Checklist**
  - [ ] Cache layers and TTLs chosen
  - [ ] Invalidation rules documented
- **Deep dive:** [Caching Strategy (what/where/TTL/invalidation)](details/api_service_teaching_deep_part2.md#26-caching-strategy-whatwerettlinvalidation)

#### 27) State boundaries
- **What:** What is stateless vs. where session/state lives.
- **Why:** Scalability and reliability.
- **How:** Keep services stateless; store state in DB/redis/object storage.
- **Checklist**
  - [ ] Stateless by default
  - [ ] Clear state stores per kind of data
- **Deep dive:** [State Boundaries (stateless services; where state lives)](details/api_service_teaching_deep_part2.md#27-state-boundaries-stateless-services-where-state-lives)

---

### Reliability & Resilience

#### 28) SLOs & error budgets
- **What:** Target reliability (e.g., 99.9% availability) and allowed error time (budget).
- **Why:** Guides release pace and incident response.
- **How:** Define per endpoint latency/availability; tie alerts to SLOs.
- **Checklist**
  - [ ] SLOs per critical endpoint
  - [ ] Error budget policy agreed
- **Deep dive:** [SLOs & Error Budgets (targets that guide change)](details/api_service_teaching_deep_part3.md#28-slos--error-budgets-targets-that-guide-change)

#### 29) Timeouts, retries, circuit breakers
- **What:** Timeouts stop waiting; retries reattempt; breakers stop cascades.
- **Why:** Prevents stuck threads and meltdowns.
- **How:** Set **shorter client timeouts** than server; retry **idempotent** ops with backoff/jitter; open breaker on high failure.
- **Checklist**
  - [ ] Timeouts on every hop
  - [ ] Safe retry policy; jitter on backoff
  - [ ] Circuit breaker thresholds
- **Deep dive:** [Timeouts, Retries with Jitter, Circuit Breakers](details/api_service_teaching_deep_part3.md#29-timeouts-retries-with-jitter-circuit-breakers)

#### 30) Bulkheads & isolation
- **What:** Separate resource pools/queues per dependency or tenant.
- **Why:** One slow dependency shouldn't sink the ship.
- **How:** Connection pools, thread pools, queue partitioning.
- **Checklist**
  - [ ] Pools per critical dependency
  - [ ] Isolation tests in staging
- **Deep dive:** [Bulkheads & Isolation (contain blast radius)](details/api_service_teaching_deep_part3.md#30-bulkheads--isolation-contain-blast-radius)

#### 31) Load shedding & overload protection
- **What:** Say "no" early when overwhelmed.
- **Why:** Preserve service for most users.
- **How:** 503 with `Retry‑After`, priority lanes, queue limits.
- **Checklist**
  - [ ] Shed strategy defined
  - [ ] Priority rules documented
- **Deep dive:** [Load Shedding & Overload Protection](details/api_service_teaching_deep_part3.md#31-load-shedding--overload-protection)

#### 32) Startup/shutdown hooks
- **What:** Health gates on start; graceful drain on shutdown.
- **Why:** Avoid serving before ready; avoid dropping in‑flight requests.
- **How:** Readiness/liveness probes; connection drain on SIGTERM.
- **Checklist**
  - [ ] Readiness blocks traffic until warm
  - [ ] Graceful shutdown implemented
- **Deep dive:** [Startup Readiness & Graceful Shutdown](details/api_service_teaching_deep_part3.md#32-startup-readiness--graceful-shutdown)

#### 33) Chaos & fault injection
- **What:** Intentionally add latency/errors to test resilience.
- **Why:** Find weaknesses before production does.
- **How:** Enable in staging and limited production canaries.
- **Checklist**
  - [ ] Fault injection plan
  - [ ] Results feed into fixes
- **Deep dive:** [Chaos & Fault Injection (practice failure safely)](details/api_service_teaching_deep_part3.md#33-chaos--fault-injection-practice-failure-safely)

---

### Performance & Scalability

#### 34) Perf budgets
- **What:** Target latency (P50/P95) per endpoint and resource usage.
- **Why:** Keeps UX snappy and costs in check.
- **How:** Measure, set targets, track in dashboards.
- **Checklist**
  - [ ] P50/P95 per critical endpoint
  - [ ] CPU/mem/IO budgets documented
- **Deep dive:** [Performance Budgets (P50/P95/P99) & Tail Latency](details/api_service_teaching_deep_part3.md#34-performance-budgets-p50p95p99--tail-latency)

#### 35) Load testing (ramp & soak)
- **What:** Simulate increasing traffic and long steady traffic.
- **Why:** Catch bottlenecks and memory leaks.
- **How:** Automate in CI; define pass/fail thresholds.
- **Checklist**
  - [ ] Ramp test and soak test scripts
  - [ ] Regressions gate releases
- **Deep dive:** [Load Testing (ramp & soak)](details/api_service_teaching_deep_part3.md#35-load-testing-ramp--soak)

#### 36) N+1 and indexes
- **What:** Avoid many tiny queries; ensure indexes support your reads.
- **Why:** Massive slowdowns otherwise.
- **How:** Profile hot paths; add `JOIN`/preload; verify index usage.
- **Checklist**
  - [ ] N+1 eliminated on hot paths
  - [ ] Slow queries have proper indexes
- **Deep dive:** [N+1 Queries & Index Hygiene](details/api_service_teaching_deep_part3.md#36-n1-queries--index-hygiene)

#### 37) Throughput model & limits
- **What:** Expected QPS, payload sizes, fan‑out, queue depth.
- **Why:** Capacity planning and safe limits.
- **How:** Document assumptions and enforce server caps.
- **Checklist**
  - [ ] QPS & payload limits set
  - [ ] Fan‑out and queue depth bounded
- **Deep dive:** [Throughput Model (Little's Law) & Limits](details/api_service_teaching_deep_part3.md#37-throughput-model-littles-law--limits)

#### 38) Content size & compression
- **What:** Cap response sizes; compress where it helps.
- **Why:** Avoid timeouts and high bandwidth.
- **How:** Gzip/Brotli for text; streaming for large payloads.
- **Checklist**
  - [ ] Max payload sizes defined
  - [ ] Compression enabled when appropriate
- **Deep dive:** [Content Size & Compression (cost vs. CPU)](details/api_service_teaching_deep_part3.md#38-content-size--compression-cost-vs-cpu)

---

### Security & Privacy

#### 39) Threat model (STRIDE) & mitigations
- **What:** Systematically list threats (Spoofing, Tampering, Repudiation, Info disclosure, DoS, Elevation).
- **Why:** Don't miss obvious risks.
- **How:** Draw data flows; list threats; map to controls.
- **Checklist**
  - [ ] Threats documented per data flow
  - [ ] Mitigations mapped and owned
- **Deep dive:** [Threat Model (STRIDE) & Data Flow Diagrams](details/api_service_teaching_deep_part4.md#39-threat-model-stride--data-flow-diagrams)

#### 40) TLS everywhere; mTLS internal
- **What:** Encrypt in transit; mutual TLS for service‑to‑service.
- **Why:** Protect data on the wire; authenticate services.
- **How:** Modern TLS, cert rotation, HSTS for web.
- **Checklist**
  - [ ] TLS enforced externally
  - [ ] mTLS for internal calls (where feasible)
- **Deep dive:** [TLS Everywhere; mTLS for Service‑to‑Service](details/api_service_teaching_deep_part4.md#40-tls-everywhere-mtls-for-servicetoservice)

#### 41) Input validation & SSRF protection
- **What:** Validate/normalize inputs; block server‑side request forgery on egress.
- **Why:** Prevent injection and data exfiltration.
- **How:** Schema validation; allow‑list outbound hosts; no raw URL fetches from user input.
- **Checklist**
  - [ ] Strong input validation
  - [ ] Egress allow‑list and metadata stripping
- **Deep dive:** [Input Validation & SSRF Protection](details/api_service_teaching_deep_part4.md#41-input-validation--ssrf-protection)

#### 42) Secrets management
- **What:** Store secrets in a vault/KMS; rotate regularly.
- **Why:** Reduce blast radius.
- **How:** No plaintext in env vars or code; short‑lived credentials.
- **Checklist**
  - [ ] Vault/KMS integrated
  - [ ] Rotation automation
- **Deep dive:** [Secrets Management (vault, rotation, least privilege)](details/api_service_teaching_deep_part4.md#42-secrets-management-vault-rotation-least-privilege)

#### 43) Data classification & lifecycle
- **What:** Classify data (public/internal/sensitive) and set retention/deletion.
- **Why:** Meet laws and reduce risk.
- **How:** Tag fields with sensitivity; define retention; implement deletion flows.
- **Checklist**
  - [ ] Data classes defined
  - [ ] Retention & deletion implemented
- **Deep dive:** [Data Classification, Retention & Deletion](details/api_service_teaching_deep_part4.md#43-data-classification-retention--deletion)

#### 44) Browser‑specific protections (if applicable)
- **What:** CORS, CSRF, and security headers (CSP, HSTS).
- **Why:** Prevent web attack classes.
- **How:** Tight CORS allow‑list; CSRF tokens for cookies; strict CSP.
- **Checklist**
  - [ ] CORS allow‑list only
  - [ ] CSRF protection in place
  - [ ] CSP/HSTS headers set
- **Deep dive:** [Browser Protections (CORS, CSRF, Security Headers)](details/api_service_teaching_deep_part4.md#44-browser-protections-cors-csrf-security-headers)

---

### Observability

#### 45) Structured logs & trace IDs
- **What:** JSON logs with a `trace_id` to tie requests across services.
- **Why:** Faster debugging.
- **How:** Use `traceparent` header; include `request_id`, user/tenant (non‑PII) where needed.
- **Checklist**
  - [ ] JSON logs with correlation IDs
  - [ ] Log sampling and retention policy
- **Deep dive:** [Structured Logs & Correlation (trace/log IDs)](details/api_service_teaching_deep_part4.md#45-structured-logs--correlation-tracelog-ids)

#### 46) Metrics (RED & USE)
- **What:** **RED:** Rate, Errors, Duration for APIs. **USE:** Utilization, Saturation, Errors for resources.
- **Why:** Standard views keep teams aligned.
- **How:** Export metrics per endpoint and resource; alert on SLOs.
- **Checklist**
  - [ ] RED for all endpoints
  - [ ] USE for key resources (CPU, DB, queues)
- **Deep dive:** [Metrics (RED for APIs, USE for resources)](details/api_service_teaching_deep_part4.md#46-metrics-red-for-apis-use-for-resources)

#### 47) Distributed tracing
- **What:** Spans for each outbound call; link to logs.
- **Why:** See where time is spent.
- **How:** Propagate trace headers; add tags (endpoint, tenant, result).
- **Checklist**
  - [ ] Tracing enabled with outbound spans
  - [ ] Exemplars link logs ↔ traces
- **Deep dive:** [Distributed Tracing (follow a request end‑to‑end)](details/api_service_teaching_deep_part4.md#47-distributed-tracing-follow-a-request-endtoend)

#### 48) Dashboards, alerts, runbooks
- **What:** Visuals and alerts with how‑to‑fix steps.
- **Why:** Cut MTTR; reduce alert fatigue.
- **How:** Dashboard per SLO; alerts with owner and runbook.
- **Checklist**
  - [ ] Actionable alerts (no noise)
  - [ ] Runbooks up‑to‑date
- **Deep dive:** [Dashboards, Alerts & Runbooks (actionable operations)](details/api_service_teaching_deep_part4.md#48-dashboards-alerts--runbooks-actionable-operations)

#### 49) Audit logs
- **What:** Tamper‑evident logs of sensitive actions.
- **Why:** Security and compliance.
- **How:** Append‑only store; access controlled; regular review.
- **Checklist**
  - [ ] Audit log coverage defined
  - [ ] Storage is tamper‑evident
- **Deep dive:** [Audit Logs (tamper‑evident records of sensitive actions)](details/api_service_teaching_deep_part4.md#49-audit-logs-tamperevident-records-of-sensitive-actions)

---

### Testing Strategy

#### 50) Unit tests
- **What:** Test small pieces of logic.
- **Why:** Prevent regressions cheaply.
- **How:** Cover edge cases and invariants.
- **Checklist**
  - [ ] High‑value logic covered
  - [ ] Edge cases included
- **Deep dive:** [Unit Tests (fast correctness checks)](details/api_service_teaching_deep_part5.md#50-unit-tests-fast-correctness-checks)

#### 51) Contract tests (consumer‑driven)
- **What:** Ensure the API/event contract matches real consumers' expectations.
- **Why:** Protect against breaking changes.
- **How:** Pact‑style or schema‑based tests run in CI.
- **Checklist**
  - [ ] Producer & consumer tests in CI
  - [ ] Schemas versioned
- **Deep dive:** [Contract Tests (consumer‑driven confidence)](details/api_service_teaching_deep_part5.md#51-contract-tests-consumerdriven-confidence)

#### 52) Integration tests
- **What:** Test with real deps or faithful fakes.
- **Why:** Catch wiring/config issues.
- **How:** Stand up minimal stack; seed data.
- **Checklist**
  - [ ] Critical flows tested end‑to‑end
  - [ ] Realistic test data
- **Deep dive:** [Integration Tests (wiring and configuration)](details/api_service_teaching_deep_part5.md#52-integration-tests-wiring-and-configuration)

#### 53) E2E smoke & canaries
- **What:** Simple "does it work" tests in prod‑like env; canary deploy checks.
- **Why:** Catch last‑mile issues.
- **How:** Synthetic monitors hit key endpoints; verify canary metrics.
- **Checklist**
  - [ ] Synthetic checks cover core journeys
  - [ ] Canary gates deployment
- **Deep dive:** [End‑to‑End Smokes & Canaries](details/api_service_teaching_deep_part5.md#53-endtoend-smokes--canaries)

#### 54) Fuzz & property‑based tests
- **What:** Randomized inputs and math‑like property checks.
- **Why:** Finds weird edge cases.
- **How:** Generate inputs; assert invariant properties.
- **Checklist**
  - [ ] Fuzz on parsers/validators
  - [ ] Properties defined for critical logic
- **Deep dive:** [Fuzz & Property‑Based Tests](details/api_service_teaching_deep_part5.md#54-fuzz--propertybased-tests)

#### 55) Resilience, load, and soak tests
- **What:** Test timeouts, retries; sustained traffic.
- **Why:** Validate robustness at scale.
- **How:** Inject faults; run hours‑long soaks.
- **Checklist**
  - [ ] Retry/timeout scenarios covered
  - [ ] Soak tests pass without leaks
- **Deep dive:** [Resilience, Load & Soak Tests](details/api_service_teaching_deep_part5.md#55-resilience-load--soak-tests)

---

### Delivery & Change Management

#### 56) Infrastructure as Code (IaC)
- **What:** Define infra in code (Terraform/Pulumi) with reviews.
- **Why:** Reproducible, auditable infra.
- **How:** PR reviews, drift detection, state backups.
- **Checklist**
  - [ ] IaC repo with reviews
  - [ ] Drift detection enabled
- **Deep dive:** [Infrastructure as Code (IaC)](details/api_service_teaching_deep_part5.md#56-infrastructure-as-code-iac)

#### 57) CI/CD pipeline
- **What:** Build → test → security scan → deploy → verify → rollback.
- **Why:** Safe, fast releases.
- **How:** Automate each stage; keep rollback simple.
- **Checklist**
  - [ ] Verified pipeline with gates
  - [ ] One‑click rollback
- **Deep dive:** [CI/CD Pipeline (build → test → scan → deploy → verify → rollback)](details/api_service_teaching_deep_part5.md#57-cicd-pipeline-build--test--scan--deploy--verify--rollback)

#### 58) Release strategies
- **What:** Canary, blue‑green, feature flags.
- **Why:** Reduce risk of bad deploys.
- **How:** Route small % traffic; keep dual stacks until healthy.
- **Checklist**
  - [ ] Canary or blue‑green plan
  - [ ] Flags for risky features
- **Deep dive:** [Release Strategies (canary, blue‑green, feature flags)](details/api_service_teaching_deep_part5.md#58-release-strategies-canary-bluegreen-feature-flags)

#### 59) Supply chain security
- **What:** Artifact provenance and SBOM; dependency scanning.
- **Why:** Guard against compromised builds.
- **How:** Sign artifacts; generate SBOM; scan deps.
- **Checklist**
  - [ ] Artifact signing
  - [ ] SBOM + scans in CI
- **Deep dive:** [Supply Chain Security (provenance, SBOM, scanning)](details/api_service_teaching_deep_part5.md#59-supply-chain-security-provenance-sbom-scanning)

#### 60) Rollout for consumers
- **What:** Communicate changes; dual‑read/write during transitions.
- **Why:** Smooth migrations.
- **How:** Feature flags, compatibility layers, migration guides.
- **Checklist**
  - [ ] Consumer rollout plan
  - [ ] Dual‑write/read where needed
- **Deep dive:** [Consumer Rollout & Compatibility (migration paths)](details/api_service_teaching_deep_part5.md#60-consumer-rollout--compatibility-migration-paths)

---

### Cost & Capacity

#### 61) Capacity planning
- **What:** Headroom for P95 load plus bursts; multi‑AZ baseline.
- **Why:** Avoid brown‑outs.
- **How:** Model CPU/mem/IO; auto‑scale policies.
- **Checklist**
  - [ ] Headroom targets set
  - [ ] Multi‑AZ and autoscaling configured
- **Deep dive:** [Capacity Planning (headroom, multi‑AZ, failover)](details/api_service_teaching_deep_part5.md#61-capacity-planning-headroom-multi-az-failover)

#### 62) Cost guardrails
- **What:** Budgets, alerts, and per‑tenant cost visibility.
- **Why:** Prevent surprises; enable chargeback.
- **How:** Tagging; dashboards; anomaly alerts.
- **Checklist**
  - [ ] Budget alerts
  - [ ] Cost per tenant/feature tracked
- **Deep dive:** [Cost Guardrails (budgets, tags, per‑tenant visibility)](details/api_service_teaching_deep_part5.md#62-cost-guardrails-budgets-tags-per-tenant-visibility)

#### 63) Hot‑spot analysis
- **What:** Find the top resource hogs (queries, allocators).
- **Why:** Focus optimization.
- **How:** Top‑N dashboards; cache hit rate monitors.
- **Checklist**
  - [ ] Top‑N views in place
  - [ ] Cache hit rate tracked
- **Deep dive:** [Hot‑Spot Analysis (find the biggest hogs)](details/api_service_teaching_deep_part5.md#63-hot-spot-analysis-find-the-biggest-hogs)

---

### Compliance & Governance (if applicable)

#### 64) Regulatory scope
- **What:** Which laws apply (GDPR/CCPA/PCI/HIPAA).
- **Why:** Avoid violations and fines.
- **How:** List applicable regs; map controls.
- **Checklist**
  - [ ] Applicable regulations identified
  - [ ] Controls mapped to requirements
- **Deep dive:** [Regulatory Scope (GDPR/CCPA/PCI/HIPAA, etc.)](details/api_service_teaching_deep_part5.md#64-regulatory-scope-gdprccpapcihipaa-etc)

#### 65) Data subject rights & DLP
- **What:** Export/delete personal data; prevent leaks.
- **Why:** Legal obligation and trust.
- **How:** Self‑service exports; deletion queues; DLP checks on logs/exports.
- **Checklist**
  - [ ] Export/delete flows implemented
  - [ ] DLP scanning configured
- **Deep dive:** [Data Subject Rights & DLP (delete/export; prevent leaks)](details/api_service_teaching_deep_part5.md#65-data-subject-rights--dlp-deleteexport-prevent-leaks)

#### 66) Access reviews & break‑glass
- **What:** Regular audits of who can do what; emergency access process.
- **Why:** Least privilege and safe emergencies.
- **How:** Quarterly reviews; audit trail for break‑glass usage.
- **Checklist**
  - [ ] Scheduled access reviews
  - [ ] Documented break‑glass process
- **Deep dive:** [Access Reviews & Break‑Glass (least privilege with escape hatch)](details/api_service_teaching_deep_part5.md#66-access-reviews--break-glass-least-privilege-with-escape-hatch)

---

## Go‑Live Readiness

- [ ] On‑call rotation and escalation paths are ready; runbooks linked
- [ ] SLO dashboards green in staging with production‑like traffic
- [ ] Synthetic monitors for critical user journeys
- [ ] Error budgets and alert thresholds reviewed
- [ ] Backups & restore drills passed; **RPO**/**RTO** verified
- [ ] Incident comms templates ready; status page playbook exists
- [ ] Business continuity test (kill a zone; system still serves)
- [ ] Legal/privacy docs current; ToS/DPAs done if needed

---

## Protocol Quick Guides

### REST Quick Guide

- **Resource naming:** use **nouns** and plurals (`/orders`, `/orders/{id}/refunds`).  
- **HTTP semantics:** GET/HEAD = safe; PUT/DELETE = idempotent; POST = create/unsafe.  
- **Partial updates:** use **PATCH**; document rules.  
- **Caching:** `ETag`/`Last-Modified`; `Cache-Control: max-age=..., stale-while-revalidate=...`; support 304 Not Modified.  
- **Errors:** Use **Problem Details** style fields (`type`, `title`, `status`, `detail`, `instance`) or your standard schema.

### gRPC Quick Guide

- **Compatibility:** Never reuse field numbers; if removed, mark as `reserved`. Prefer adding optional fields.
- **Deadlines:** Every call sets a deadline (timeout); server enforces max message sizes.
- **Streaming:** Implement backpressure/cancellation for client/server streaming.
- **Errors:** Use `google.rpc.Status` with rich details; map to client UX.
- **Ops:** Enable health checking (`grpc.health.v1`) and server reflection for tooling.

### Eventing/Async Quick Guide

- **Schema:** Version your event schema; keep a registry.
- **Delivery:** Pick semantics (at‑least‑once is common); ensure **consumer idempotency**.
- **Ordering:** Use ordering/shard keys where needed.
- **DLQ:** Dead‑letter queue with replay; make handlers **replay‑safe** (dedupe or no side‑effects).

---

## Templates & Snippets

### A) Error schema (JSON)
```json
{
  "type": "https://errors.example.com/validation",
  "code": "invalid_parameter",
  "message": "Parameter 'amount' must be >= 1.00.",
  "details": { "field": "amount", "min": 100 },
  "request_id": "req_123"
}
```

### B) OpenAPI snippet (YAML)
```yaml
openapi: 3.0.3
info:
  title: Refund API
  version: 1.0.0
paths:
  /refunds:
    post:
      summary: Create a refund
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRefundRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Refund'
        '409':
          description: Conflict (idempotency)
  /refunds/{id}:
    get:
      summary: Get a refund
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
components:
  schemas:
    CreateRefundRequest:
      type: object
      required: [order_id, amount]
      properties:
        order_id: { type: string }
        amount: { type: integer, description: "Minor units (e.g., cents)" }
    Refund:
      type: object
      properties:
        id: { type: string }
        order_id: { type: string }
        amount: { type: integer }
        status: { type: string, enum: [pending, succeeded, failed] }
```

### C) Rate limit & caching headers (HTTP)
```http
HTTP/1.1 200 OK
Content-Type: application/json
ETag: "v7"
Cache-Control: max-age=60, stale-while-revalidate=120
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 72
X-RateLimit-Reset: 1735689600
```

### D) Idempotent POST with replay‑safe server
```http
POST /refunds
Idempotency-Key: 3bbf9b0c-...

{ "order_id": "o_123", "amount": 1000 }
```

Server stores (`Idempotency-Key` → hash(request) + response) for 24h; a retry with same key returns the first response.

### E) ETag / If‑Match optimistic concurrency
```http
GET /orders/123
ETag: "v7"

PATCH /orders/123
If-Match: "v7"
{ "note": "Ship ASAP" }
```

---

## Glossary (simple definitions)

- **ABAC:** Authorization by attributes/conditions (e.g., “tenant == request.tenant && role == ‘manager’”).  
- **Audit log:** Special log of sensitive actions, protected from tampering.  
- **Blue‑green:** Keep old and new versions; switch traffic once healthy.  
- **Breaker (circuit breaker):** Temporarily stop calling a failing dependency.  
- **Canary:** Release to a small %; watch metrics before full rollout.  
- **Cache (CDN/edge/service/DB):** Temporary storage to speed reads.  
- **Clock skew:** Small time differences between machines.  
- **Consistency (strong/eventual/read‑your‑writes):** How fresh your reads are after writes.  
- **CORS:** Browser rule that controls which sites can call your API from JS.  
- **CSP:** Browser header that limits what scripts/resources can load.  
- **CSRF:** Browser attack where a victim’s browser sends unwanted requests.  
- **DLQ (dead‑letter queue):** Holding area for messages the consumer can’t process.  
- **DLP:** Tools that prevent sensitive data from leaking (e.g., in logs).  
- **ETag:** Version tag for a resource; helps caching and concurrency control.  
- **Fan‑out:** How many downstream calls one request triggers.  
- **Feature flag:** Toggle a feature on/off at runtime.  
- **gRPC/Protobuf:** High‑performance binary RPC framework and schema language.  
- **HSTS:** Header telling browsers to only use HTTPS for your domain.  
- **Idempotency:** Safe to retry the same call without double side‑effects.  
- **ISO‑8601 / RFC 3339:** Standard formats for durations and timestamps.  
- **JWT:** Signed token that asserts identity/claims.  
- **Least privilege:** Give only the permissions needed, no more.  
- **mTLS:** Mutual TLS where both sides present certs to authenticate.  
- **N+1:** Pattern of many small queries instead of one efficient query.  
- **OpenAPI:** Machine‑readable spec for REST APIs.  
- **P50/P95:** Median and 95th‑percentile latency; P95 shows tail behavior.  
- **PII:** Personally identifiable information.  
- **Problem Details:** Standard style for HTTP error bodies.  
- **RBAC:** Authorization by roles (admin, editor, viewer).  
- **RED/USE:** Metric groupings for APIs (RED) and resources (USE).  
- **Replay‑safe:** If the same message/process runs again, it doesn’t cause harm.  
- **RPO/RTO:** Max acceptable data loss (RPO) and time to restore (RTO).  
- **SBOM:** Software Bill of Materials — list of components in a build.  
- **Schema registry:** Place to publish and version your event schemas.  
- **SLO:** Service Level Objective — your reliability target.  
- **Soak test:** Long‑running load test.  
- **SSRF:** Attack that tricks your server to fetch internal resources.  
- **Stale‑while‑revalidate:** Serve cached content while fetching fresh in background.  
- **STRIDE:** Threat modeling mnemonic (Spoofing, Tampering, Repudiation, Info disclosure, DoS, Elevation).  
- **Traceparent:** W3C header carrying the trace ID for distributed tracing.  
- **ULID/UUIDv7:** ID formats that sort by time (useful for paging).  
- **Versioning (API):** Rules for changing an API without breaking clients.

---

## Scorecard (one‑page checklist)

> Copy this block into PRs or design reviews and tick items as you complete them.

```md
### API Definition
- [ ] Problem, users, success metrics, out‑of‑scope
- [ ] Resource model & operations
- [ ] Consistency model per endpoint
- [ ] Idempotency for non‑GET writes
- [ ] Concurrency (ETag/If‑Match)
- [ ] Time semantics (UTC RFC3339, ISO‑8601)
- [ ] Transport chosen & justified
- [ ] Versioning & deprecation policy
- [ ] Pagination (cursor), filtering, sorting
- [ ] Error schema + partial success rules
- [ ] Rate limit contract (429, headers)
- [ ] Standard headers (trace, cache, content type)
- [ ] AuthN/AuthZ model; secret handling
- [ ] Executable spec; quickstart; changelog; mocks/SDKs

### Service Build
- [ ] Data model & access patterns; indexes
- [ ] Migrations (expand → migrate → contract)
- [ ] Identifier format (UUIDv7/ULID); non‑guessable
- [ ] Caching plan; invalidation
- [ ] Stateless services; state stores
- [ ] SLOs & error budgets
- [ ] Timeouts, retries (with jitter), breakers
- [ ] Bulkheads & load shedding
- [ ] Startup readiness; graceful shutdown
- [ ] Chaos/fault injection plan
- [ ] Perf budgets; load/soak tests; N+1 fixed
- [ ] Throughput model; size limits; compression
- [ ] Threat model; TLS/mTLS; SSRF protection
- [ ] Secrets in vault; rotation
- [ ] Data classification; retention & deletion
- [ ] CORS/CSRF (if browser); CSP/HSTS
- [ ] Logs (JSON) with trace IDs; metrics RED/USE; tracing
- [ ] Dashboards, alerts, runbooks; audit logs
- [ ] IaC with reviews & drift detection
- [ ] CI/CD with scans; rollback
- [ ] Canary/blue‑green; feature flags
- [ ] Supply chain (signing, SBOM, scans)
- [ ] Consumer rollout; dual‑read/write if needed
- [ ] Capacity plan; multi‑AZ; autoscaling
- [ ] Cost guardrails; per‑tenant attribution
- [ ] Hot‑spot dashboards & cache hit rate
- [ ] Compliance scope; DSR flows; DLP
- [ ] Access reviews; break‑glass process

### Go‑Live
- [ ] On‑call & runbooks; escalation paths
- [ ] SLO dashboards green with prod‑like traffic
- [ ] Synthetic monitors for critical journeys
- [ ] Error budgets & alerts reviewed
- [ ] Backups/restore drill; RPO/RTO met
- [ ] Incident comms templates; status page playbook
- [ ] Zone failure test passed
- [ ] Legal/privacy docs updated
```
